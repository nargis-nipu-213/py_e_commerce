<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cart</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

    <main class="flex-1 py-8 px-4">

        <div class="max-w-6xl mx-auto px-6">

            <h1 class="text-4xl font-bold text-gray-800 mb-10 text-center">My Cart</h1>

            {% if message %}
            <p class="text-green-500 text-center mb-4">{{ message }}</p>
            {% endif %}
            {% if error %}
            <p class="text-red-500 text-center mb-4">{{ error }}</p>
            {% endif %}

            {% if cart %}
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Items list -->
                <div class="lg:col-span-2 space-y-6">
                    {% for item in cart %}
                    <div class="bg-white rounded-2xl shadow-md p-6 flex items-center gap-6 order-item"
                        data-product-id="{{ item.product_id }}">
                        <div class="w-24 h-24 flex-shrink-0 rounded-lg overflow-hidden bg-gray-50">
                            {% if item.image_url %}
                            <img src="{{ item.image_url }}" alt="{{ item.product_name }}"
                                class="w-full h-full object-cover">
                            {% else %}
                            <div class="w-full h-full flex items-center justify-center text-gray-400">No Image</div>
                            {% endif %}
                        </div>

                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-gray-800 truncate">{{ item.product_name }}</h3>
                            <p class="text-sm text-gray-500">Unit: ${{ "%.2f"|format(item.price|float) }}</p>

                            <div class="mt-3 flex items-center justify-between gap-6">
                                <div class="text-sm text-gray-700">Qty: {{ item.quantity }}</div>

                                <div class="text-right">
                                    <div class="text-sm text-gray-500">Item total</div>
                                    <div class="item-total font-bold text-gray-900"
                                        data-total="{{ (item.price|float * item.quantity|float) }}">${{
                                        "%.2f"|format((item.price|float * item.quantity|float)) }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col items-end gap-2">
                            <form method="POST"
                                action="{{ url_for('cart.remove_from_cart', product_id=item.product_id) }}">
                                <button type="submit" class="text-sm text-red-600 hover:underline">Remove</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Summary -->
                <aside class="bg-white rounded-2xl p-8 shadow-md">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Order Summary</h2>
                    <div class="flex justify-between text-gray-600 mb-2">
                        <div>Subtotal</div>
                        <div id="cart-subtotal" data-value="{{ total_price|default(0)|float }}">${{
                            "%.2f"|format(total_price|default(0)|float) }}</div>
                    </div>
                    <div class="flex justify-between text-gray-600 mb-4">
                        <div>Shipping</div>
                        <div id="cart-shipping">$0.00</div>
                    </div>
                    <div class="border-t border-gray-100 pt-4 flex justify-between items-center">
                        <div class="text-lg font-semibold">Total</div>
                        <div id="cart-total" class="text-xl font-bold text-gray-900">${{
                            "%.2f"|format(total_price|default(0)|float) }}</div>
                    </div>

                    <div class="mt-6 flex flex-col gap-3">
                        <a href="{{ url_for('order.payment') }}"
                            class="w-full text-center bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-5 py-3 rounded-lg font-medium">Checkout</a>
                        <a href="{{ url_for('dashboard') }}"
                            class="w-full text-center bg-gray-100 text-gray-800 px-5 py-3 rounded-lg">Continue
                            shopping</a>
                    </div>
                </aside>

            </div>

            {% else %}
            <div class="text-center">
                <p class="text-gray-700 mb-4 text-lg">Your cart is empty.</p>
                <a href="{{ url_for('dashboard') }}" class="inline-block text-blue-500 hover:underline font-medium">←
                    Back
                    to Shop</a>
            </div>
            {% endif %}

        </div>

    </main>

    <footer class="bg-gradient-to-r from-white to-blue-50 border-t">
        <div class="max-w-[1400px] mx-auto px-6 py-6 text-sm text-gray-600">© {{ current_year or "2026" }} MyShop —
            Built with care.</div>
    </footer>

</body>

</html>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        function recalc() {
            var subtotal = 0;
            document.querySelectorAll('.item-total[data-total]').forEach(function (el) {
                var parent = el.closest('.order-item') || el.closest('.order-item') || el.closest('[data-product-id]');
                // Only include visible items
                if (parent && parent.offsetParent === null) return;
                var v = parseFloat(el.getAttribute('data-total'));
                if (!isNaN(v)) subtotal += v;
            });
            // also consider any item-total elements without data-total (compute from qty input)
            document.querySelectorAll('.order-item').forEach(function (container) {
                var it = container.querySelector('.item-total');
                if (it && !it.hasAttribute('data-total')) {
                    var input = container.querySelector('.qty-input');
                    var price = parseFloat(input && input.getAttribute('data-price')) || 0;
                    var qty = parseFloat(input && input.value) || 0;
                    subtotal += price * qty;
                }
            });

            var shipping = 0;
            var total = subtotal + shipping;
            var elSub = document.getElementById('cart-subtotal');
            if (elSub) elSub.textContent = '$' + subtotal.toFixed(2);
            var elShip = document.getElementById('cart-shipping');
            if (elShip) elShip.textContent = '$' + shipping.toFixed(2);
            var elTotal = document.getElementById('cart-total');
            if (elTotal) elTotal.textContent = '$' + total.toFixed(2);
        }

        // initial recalc using server-provided item totals
        recalc();
    });
</script>